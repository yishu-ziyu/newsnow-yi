"use strict";Object.defineProperty(exports, "__esModule", { value: true });exports.RollopGlob = RollopGlob;var _nodePath = _interopRequireDefault(await jitiImport("node:path"));
var _promises = await jitiImport("node:fs/promises");

var _fastGlob = _interopRequireDefault(await jitiImport("fast-glob"));

var _pluginutils = await jitiImport("@rollup/pluginutils");
var _dir = await jitiImport("../shared/dir");function _interopRequireDefault(e) {return e && e.__esModule ? e : { default: e };}

const ID_PREFIX = "glob:";
const root = _nodePath.default.join(_dir.projectDir, "server");


function RollopGlob() {
  const map = {};
  const include = [];
  const exclude = [];
  const filter = (0, _pluginutils.createFilter)(include, exclude);
  return {
    name: "rollup-glob",
    resolveId(id, src) {
      if (!id.startsWith(ID_PREFIX)) return;
      if (!src || !filter(src)) return;

      return `${id}:${encodeURIComponent(src)}`;
    },
    async load(id) {
      if (!id.startsWith(ID_PREFIX)) return;

      const [_, pattern, encodePath] = id.split(":");
      const currentPath = decodeURIComponent(encodePath);

      const files = (
      await (0, _fastGlob.default)(pattern, {
        cwd: currentPath ? _nodePath.default.dirname(currentPath) : root,
        absolute: true
      })).

      map((file) => (0, _pluginutils.normalizePath)(file)).
      filter((file) => file !== (0, _pluginutils.normalizePath)(currentPath)).
      sort();
      map[pattern] = files;

      const contents = files.map((file) => {
        const r = file.replace("/index", "");
        const name = _nodePath.default.basename(r, _nodePath.default.extname(r));
        return `export * as ${name} from '${file}'\n`;
      }).join("\n");

      await writeTypeDeclaration(map, _nodePath.default.join(root, "glob"));

      return `${contents}\n`;
    }
  };
}

async function writeTypeDeclaration(map, filename) {
  function relatePath(filepath) {
    return (0, _pluginutils.normalizePath)(_nodePath.default.relative(_nodePath.default.dirname(filename), filepath));
  }

  let declare = `/* eslint-disable */\n\n`;

  const sortedEntries = Object.entries(map).sort(([a], [b]) =>
  a.localeCompare(b)
  );

  for (const [_idx, [id, files]] of sortedEntries.entries()) {
    declare += `declare module '${ID_PREFIX}${id}' {\n`;
    for (const file of files) {
      const relative = `./${relatePath(file)}`.replace(/\.tsx?$/, "");
      const r = file.replace("/index", "");
      const fileName = _nodePath.default.basename(r, _nodePath.default.extname(r));
      declare += `  export const ${fileName}: typeof import('${relative}')\n`;
    }
    declare += `}\n`;
  }
  await (0, _promises.writeFile)(`${filename}.d.ts`, declare, "utf-8");
} /* v9-941d5b01fad5e727 */
